<html>
  <head>
    <meta charset="utf-8" />
    <title>LaTeX Linter</title>
    <meta lang="ja" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body>
    <div class="flex flex-col space-y-4">
      <textarea
        id="code"
        placeholder="Your LaTeX Code"
        class="p-4 rounded-md border-gray-300 border h-40 m-4"
      >
  \begin{document}
  サンプルテキストはサンプルは素晴らしい。。
  \end{document}</textarea
      >
      <div class="flex flex-col justify-center items-center">
        <button
          id="submit"
          class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md w-1/2"
        >
          Submit
        </button>
      </div>
      <table class="table-auto border border-collapse m-4">
        <thead>
          <tr>
            <th class="px-4 py-2 bg-blue-200">line</th>
            <th class="px-4 py-2 bg-blue-200">message</th>
            <th class="px-4 py-2 bg-blue-200">url</th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
    <script>
      const code = document.getElementById("code");
      const submit = document.getElementById("submit");
      const response = document.getElementById("response");
      const tableBody = document.getElementById("table-body");

      function lint2Table(data) {
        for (let i = 0; i < data.length; i++) {
          const row = document.createElement("tr");

          const posCell = document.createElement("td");
          const posText = `${data[i].loc.start.line}-${data[i].loc.end.line}`;
          posCell.textContent = posText;
          posCell.classList.add("border", "px-4", "py-2");

          const messageCell = document.createElement("td");
          messageCell.textContent = data[i].message;
          messageCell.classList.add("border", "px-4", "py-2");

          const urlCell = document.createElement("td");
          const url = data[i].url
            ? `<a href="${data[i].url}" target="_blank" rel="noopener noreferrer">${data[i].url}</a>`
            : "";
          urlCell.innerHTML = url;
          urlCell.classList.add("border", "px-4", "py-2");

          row.appendChild(posCell);
          row.appendChild(messageCell);
          row.appendChild(urlCell);

          tableBody.appendChild(row);
        }
      }
      function setLoading() {
        submit.disabled = true;
        submit.textContent = 'Loading...(about 1min)';
      }
    
      function unsetLoading() {
        submit.disabled = false;
        submit.textContent = "Submit";
      }

      submit.addEventListener("click", async () => {
        setLoading();
        while (tableBody.firstChild){
          tableBody.removeChild(tableBody.firstChild);
        }
        const codeValue = code.value;
        const res = await fetch("http://192.168.100.33:8080", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ code: codeValue }),
        });
        const json = await res.json();
        if(json.length === 0) {
          alert("No lint error found!");
        } else {
          lint2Table(json);
        }
        unsetLoading();
      });
    </script>
  </body>
</html>
